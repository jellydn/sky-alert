# Ralph Progress Log
Started: Thu Feb 19 11:09:23 +08 2026
---

## Thu Feb 19 11:12:34 +08 2026 - US-001
- Initialized TypeScript project with grammy, drizzle-orm, and better-sqlite3
- Created database schema with three tables: flights, tracked_flights, status_changes
- Set up Drizzle ORM configuration and generated migrations
- Database migrations run successfully with all tables created
- Typecheck passes
- Files changed: package.json, tsconfig.json, drizzle.config.ts, src/db/schema.ts, src/db/index.ts, src/index.ts, .env.example, .gitignore
**Learnings for future iterations:**
- Drizzle Kit uses "dialect: 'sqlite'" instead of "driver" in config
- Migrations are generated in drizzle/ directory and should be committed
- SQLite database file is created in data/ directory on first migration
---

## Thu Feb 19 11:15:42 +08 2026 - US-002
- Set up Telegram bot using grammY framework
- Implemented /start command with welcome message
- Implemented /help command with list of available commands
- Bot connects to Telegram using BOT_TOKEN env variable
- Bot uses long polling (default grammY behavior)
- Typecheck passes
- Files changed: src/bot/index.ts, src/index.ts
**Learnings for future iterations:**
- grammY's auto-quote middleware package doesn't exist or has different name - skip for now
- Bot needs to be started after database connection is verified
- grammY uses ctx.reply() with parse_mode for formatted messages
---

## Thu Feb 19 11:18:52 +08 2026 - US-003
- Created Aviationstack API service with flight lookup functionality
- Implemented flight service with database operations (create, get, track, untrack)
- Created /track command handler that parses flight number and date
- Bot validates flight existence via Aviationstack API
- If valid, saves flight to flights table and links to chat_id in tracked_flights
- Bot replies with confirmation showing flight number, route, and times
- Error handling for flight not found, rate limits, and API errors
- Typecheck passes
- Files changed: src/services/aviationstack.ts, src/services/flight-service.ts, src/handlers/track.ts, src/bot/index.ts
**Learnings for future iterations:**
- Aviationstack API requires access_key query parameter
- Use `as Type` casting for API responses when TypeScript can't infer types
- Bot export must be imported from bot/index.js, not root index.js
- Handlers should be imported to register their commands with the bot instance
---

## Thu Feb 19 11:22:14 +08 2026 - US-004
- Created flight input parser with regex patterns for flight numbers
- Implemented date parsing for multiple formats (ISO, slash, month names, relative dates)
- Added support for route detection (airport code + "to" + airport code)
- Created natural language handler that processes text messages
- Bot extracts flight number from free-text messages using pattern matching
- Bot understands relative dates: 'today', 'tomorrow', 'next Monday'
- Bot understands date formats: '2026-03-15', 'March 15', '15/03/2026'
- If flight number found but no date, bot asks for the date
- If no flight number found, bot shows helpful message with examples
- Extracted data follows the same track flow as US-003
- Typecheck passes
- Files changed: src/utils/flight-parser.ts, src/handlers/natural-language.ts, src/bot/index.ts
**Learnings for future iterations:**
- Use bot.on('message:text') to catch all text messages, bot.on('message') catches all message types
- Import handlers to register them - they run on module import, not on explicit call
- Remove generic message handlers when implementing specific ones
---

## Thu Feb 19 11:25:38 +08 2026 - US-005
- Added getFlightsByRoute method to Aviationstack API service
- Created pending selection utility for storing route lookup results in memory
- Updated natural language handler to detect route patterns (SFO to LAX)
- Bot queries Aviationstack API for flights matching route and date
- Bot presents up to 5 matching flights with flight number, airline, departure time
- User can reply with a number (1-5) to select which flight to track
- Selected flight is saved and tracked using the same flow as US-003
- If no flights found, bot shows clear message with helpful hints
- Pending selections expire after 5 minutes to clean up memory
- Typecheck passes
- Files changed: src/services/aviationstack.ts, src/utils/pending-selections.ts, src/handlers/natural-language.ts
**Learnings for future iterations:**
- Use in-memory Map for pending selections with timeout for cleanup
- Route detection should be checked before flight number detection
- Chat ID needs to be extracted early in the handler for all code paths
---

## Thu Feb 19 11:28:01 +08 2026 - US-006
- Created /flights command handler to list tracked flights
- /flights command queries tracked_flights table by chat_id with join to flights table
- Each entry shows: flight number, route (origin → destination), date, current status, departure time
- Flights are sorted by departure date and time (soonest first)
- If no flights tracked, bot shows helpful message suggesting /track with examples
- Typecheck passes
- Files changed: src/handlers/flights.ts, src/bot/index.ts
**Learnings for future iterations:**
- Use Drizzle's innerJoin for joining tables with select()
- Order by multiple columns using chained orderBy() calls
- Format dates and times using toLocaleTimeString() for user-friendly display
---

## Thu Feb 19 11:30:42 +08 2026 - US-007
- Created /status command handler to view current flight status
- /status AA123 command returns detailed flight info with departure and arrival times
- Shows: current status, scheduled departure/arrival times, gate, terminal, delay duration
- Shows timeline of status changes from status_changes table (newest first, limited to 10)
- If flight not tracked, bot shows error message suggesting /flights
- Typecheck passes
- Files changed: src/handlers/status.ts, src/bot/index.ts
**Learnings for future iterations:**
- Use desc() for ordering by newest first in status changes
- Limit results to avoid overwhelming users with too much history
- Format dates with month/day/time for compact display
---

## Thu Feb 19 11:33:02 +08 2026 - US-008
- Created /remove command handler to stop tracking a flight
- /remove AA123 command deletes the tracked_flights entry for this chat_id and flight
- Bot confirms removal with flight details (number, route, date)
- If no other users track this flight, it marks it as inactive (is_active = false)
- If flight not found in user's tracked list, bot shows error message suggesting /flights
- Typecheck passes
- Files changed: src/handlers/remove.ts, src/bot/index.ts
**Learnings for future iterations:**
- Check for other trackers before marking flight inactive using query().findMany()
- Use delete() with where clause to remove tracking entries
- Always confirm user actions with details of what was removed
---

## Thu Feb 19 11:36:14 +08 2026 - US-009
- Created polling service with setInterval for background worker
- Worker runs in the same process as the bot
- Worker queries all active flights that need polling
- Polls every 5 minutes for flights > 3 hours from departure
- Polls every 1 minute for flights within 3 hours of departure
- Stops polling flights that landed > 2 hours ago or are cancelled
- Deduplicates: only one API call per unique flight regardless of trackers
- Updates flight record with latest status, gate, terminal, delay info
- Respects Aviationstack API rate limits by reusing same interval per flight
- Typecheck passes
- Files changed: src/services/polling-service.ts, src/index.ts
**Learnings for future iterations:**
- Use Map to track intervals per flight to prevent duplicate polling
- Use Math.floor(Date.now() / 1000) for Unix timestamps in SQLite
- Stop polling for flights that are no longer active to save API calls
- Combine time-based conditions with OR logic for filtering active flights
---

## Thu Feb 19 11:39:28 +08 2026 - US-010
- Updated polling service to detect status changes and send alerts
- When polling detects a status change, inserts record into status_changes table
- Sends Telegram message to ALL chat_ids tracking that flight
- Message includes: flight number, old status → new status, relevant details (delay duration, new gate, etc.)
- Alerts sent for: check-in open, delay, gate change, boarding, final call, departed, landed, cancelled
- Gate or terminal changes (even without status change) also trigger alerts
- Typecheck passes
- Files changed: src/services/polling-service.ts
**Learnings for future iterations:**
- Fetch current flight state before updating to detect changes
- Track old and new values for comparison (status, gate, terminal, delay)
- Use bot.api.sendMessage() to send messages to specific chat IDs
- Wrap individual message sends in try/catch to prevent one failure from blocking others
- Build alert message dynamically based on what changed
---
